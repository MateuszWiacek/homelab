#!/bin/bash
set -euo pipefail

BACKUP_DIR="{{ mnt_fast_data }}/backups/db"
DATE=$(date +%F_%H-%M-%S)
RETENTION_DAYS={{ db_backup_retention_days }}

mkdir -p "$BACKUP_DIR"

echo "Starting Immich database backup..."
docker exec {{ immich_db_container | default('immich_postgres') }} \
  pg_dump -U {{ vault_immich_db_user | default('immich') }} {{ vault_immich_db_name | default('immich') }} \
  | gzip > "$BACKUP_DIR/immich_$DATE.sql.gz"

echo "Starting Paperless database backup..."
docker exec {{ paperless_db_container | default('paperless_db') }} \
  pg_dump -U {{ vault_paperless_db_user | default('paperless') }} {{ vault_paperless_db_name | default('paperless') }} \
  | gzip > "$BACKUP_DIR/paperless_$DATE.sql.gz"

echo "Cleaning up old backups..."
find "$BACKUP_DIR" -type f -name "*.sql.gz" -mtime +"$RETENTION_DAYS" -delete

echo "Backup completed."
