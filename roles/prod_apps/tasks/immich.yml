---
# Create local directories on Ryzen NVMe for performance-critical data
- name: "Immich | Create local app directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ app_uid }}"
    group: "{{ app_gid }}"
    mode: '0755'
  loop:
    - "{{ immich_stack_dir }}"
    - "{{ immich_db_dir }}"
    - "{{ immich_model_cache_dir }}"

- name: "Immich | Deploy docker-compose file"
  ansible.builtin.template:
    src: "immich/docker-compose.yml.j2"
    dest: "{{ immich_stack_dir }}/docker-compose.yml"
    owner: "{{ app_uid }}"
    group: "{{ app_gid }}"
    mode: '0644'

- name: "Immich | Deploy environment file"
  ansible.builtin.template:
    src: "immich/env.j2"
    dest: "{{ immich_stack_dir }}/.env"
    owner: "{{ app_uid }}"
    group: "{{ app_gid }}"
    mode: '0600'
  no_log: true

# Start the Immich stack using Docker Compose V2
- name: "Immich | Run container"
  community.docker.docker_compose_v2:
    project_src: "{{ immich_stack_dir }}"
    state: present
    # Explicitly point to the .env file to avoid "variable not set" warnings
    files:
      - docker-compose.yml
    env_files:
      - .env
